
{% extends "base.html" %}
{% block content %}
<div class="w-full flex flex-col gap-2 max-w-6xl mx-auto mt-8 mb-8">
    <div class="flex items-center justify-between w-full">
        <h2 class="text-4xl font-extrabold text-center flex-1 text-purple-700 drop-shadow-lg tracking-wide">Juguemos: {{ nickname }}</h2>
        <div id="timerContainer" class="flex items-center justify-end w-48">
            <span id="timer" class="text-3xl font-bold text-blue-600 bg-blue-100 px-5 py-2 rounded-xl shadow-lg border-2 border-blue-300">01:30</span>
        </div>
    </div>
    <div class="flex flex-1 w-full gap-10">
        <!-- Zona de jugadores -->
    <!-- Zona de jugadores -->
    <div class="w-1/2 bg-white rounded-2xl shadow-2xl p-8 border-4 border-blue-300 flex flex-col items-center animate-fade-in">
        <h3 class="text-2xl font-bold mb-6 text-blue-700 tracking-wide">Jugadores conectados</h3>
        <div id="jugadores" class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full"></div>
        <button id="startBtn" class="mt-10 bg-gradient-to-r from-green-400 via-blue-400 to-purple-400 text-white font-bold px-8 py-3 rounded-xl shadow-lg hover:scale-105 hover:from-green-500 hover:to-purple-500 transition-all duration-200 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-300" style="display:none;">Comenzar</button>
    </div>
    <!-- Zona de discusión/chat -->
    <div class="w-1/2 bg-white rounded-2xl shadow-2xl p-8 border-4 border-purple-300 flex flex-col animate-fade-in">
        <h3 class="text-2xl font-bold mb-6 text-purple-700 tracking-wide">Zona de discusión</h3>
    <div id="chat" class="flex-1 overflow-y-auto mb-6 border-2 border-purple-200 rounded-xl p-4 bg-purple-50" style="min-height:220px; max-height:400px;"></div>
        <form id="chatForm" class="flex gap-2" style="display:none;">
            <input type="text" id="chatInput" class="border-2 border-purple-300 rounded-xl p-3 flex-1 focus:outline-none focus:ring-2 focus:ring-purple-400 text-lg" placeholder="Escribe tu mensaje..." autocomplete="off" required>
            <button type="submit" class="bg-purple-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-purple-600 transition-all duration-200">Enviar</button>
        </form>
        <div id="chatLocked" class="text-center text-purple-500 font-semibold mt-2">El chat se habilitará cuando el juego comience.</div>
    </div>
</div>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
    var socket = io();
    var nickname = "{{ nickname }}";
    var myWord = "???";
    var gameStarted = false;
    socket.emit('join_room', {room: 'principal', nickname: nickname});

    // Cards de jugadores (solo muestra nombre, palabra solo para el usuario actual)
    socket.on('update_players', function(players) {
        var container = document.getElementById('jugadores');
        container.innerHTML = '';
        players.forEach(function(nick) {
            var card = document.createElement('div');
            card.className = 'bg-gradient-to-br from-blue-100 via-white to-blue-200 border-2 border-blue-400 rounded-2xl p-6 shadow-lg text-center flex flex-col items-center hover:scale-105 transition-all duration-200';
            card.innerHTML = '<div class="font-bold text-xl text-blue-700 mb-2">' + nick + '</div>';
            if(nick === nickname) {
                // Solo mostrar la palabra si el juego comenzó
                if(gameStarted) {
                    card.innerHTML += '<div class="text-lg text-green-700 font-semibold mt-2">Tu palabra: <span class="font-mono bg-green-100 px-3 py-2 rounded-xl shadow" id="myWord">' + myWord + '</span></div>';
                } else {
                    card.innerHTML += '<div class="text-lg text-gray-400 font-semibold mt-2">Tu palabra: <span class="font-mono bg-gray-100 px-3 py-2 rounded-xl shadow" id="myWord">???</span></div>';
                }
                if(nickname === 'LUCAS' && !gameStarted) {
                    document.getElementById('startBtn').style.display = '';
                } else {
                    document.getElementById('startBtn').style.display = 'none';
                }
            }
            container.appendChild(card);
        });
    });

    // Cronómetro
    var timerInterval = null;
    function startTimer(duration) {
        var timer = duration, minutes, seconds;
        var timerSpan = document.getElementById('timer');
        if(timerInterval) clearInterval(timerInterval);
        timerSpan.classList.remove('bg-red-200', 'text-red-700', 'animate-bounce');
        timerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            timerSpan.textContent = minutes + ":" + seconds;
            if (--timer < 0) {
                clearInterval(timerInterval);
                timerSpan.textContent = "00:00";
                timerSpan.classList.add('bg-red-200', 'text-red-700', 'animate-bounce');
               disableChatAndShowVote(); 
                showTimeUpMessage();
               
            }
    
        }, 1000);
    }

    function disableChatAndShowVote() {
        // Deshabilitar el input, el botón y el form de chat
        document.getElementById('chatInput').disabled = true;
        document.getElementById('chatForm').style.display = 'none';
        document.getElementById('chatLocked').style.display = '';
        document.getElementById('chatLocked').textContent = 'El chat está deshabilitado. ¡Hora de votar!';
        var voteBtn = document.createElement('button');
        voteBtn.id = 'voteBtn';
        voteBtn.className = 'mt-6 bg-gradient-to-r from-yellow-400 via-red-400 to-purple-400 text-white font-bold px-8 py-3 rounded-xl shadow-lg hover:scale-105 transition-all duration-200 ease-in-out focus:outline-none focus:ring-4 focus:ring-yellow-300';
        voteBtn.textContent = 'Votar';
        voteBtn.onclick = function() {
            socket.emit('vote', {nickname: nickname});
            voteBtn.disabled = true;
            voteBtn.classList.add('opacity-50','cursor-not-allowed');
            voteBtn.textContent = 'Voto enviado';
        };
        document.getElementById('chatLocked').appendChild(voteBtn);
    }
    
    function showTimeUpMessage() {
        var container = document.getElementById('timerContainer');
        var msg = document.createElement('div');
        msg.className = 'ml-4 text-xl font-bold text-red-600 animate-pulse';
        msg.textContent = '¡Tiempo terminado!';
        container.appendChild(msg);
        setTimeout(function() {
            msg.remove();
        }, 4000);
    }


    document.getElementById('startBtn').addEventListener('click', function() {
        socket.emit('start_game');
    });

    socket.on('start_timer', function(data) {
        startTimer(data.duration);
    });

    // Palabra asignada
    socket.on('assign_word', function(data) {
        if(data.nickname === nickname) {
            myWord = data.word;
            var wordSpan = document.getElementById('myWord');
            if(wordSpan) wordSpan.textContent = myWord;
        }
    });

    // Chat
    var chat = document.getElementById('chat');
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var msg = document.getElementById('chatInput').value;
        if(msg.trim() !== '') {
            socket.emit('chat_message', {nickname: nickname, message: msg});
            document.getElementById('chatInput').value = '';
        }
    });
    socket.on('chat_message', function(data) {
        var div = document.createElement('div');
        div.className = 'mb-2';
        div.innerHTML = '<span class="font-bold text-purple-700">' + data.nickname + ':</span> <span>' + data.message + '</span>';
        chat.appendChild(div);
        // Autoscroll solo si el usuario está cerca del final
        if (chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 50) {
            chat.scrollTop = chat.scrollHeight;
        }
    });

    // Comenzar juego
    document.getElementById('startBtn').addEventListener('click', function() {
        if(nickname === 'LUCAS' && !gameStarted) {
            socket.emit('start_game');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add('opacity-50','cursor-not-allowed');
        }
    });
    socket.on('game_started', function() {
        gameStarted = true;
        document.getElementById('chatForm').style.display = '';
        document.getElementById('chatLocked').style.display = 'none';
        document.getElementById('startBtn').disabled = true;
        document.getElementById('startBtn').classList.add('opacity-50','cursor-not-allowed');
    });
</script>
{% endblock %}
